# دليل اختبار روابط إعادة تعيين كلمة المرور

## 🔍 المشكلة

رابط إعادة تعيين كلمة المرور في البريد الإلكتروني لا يفتح بشكل صحيح.

## 🛠️ الحلول المطبقة

### 1. تحسين معالجة معاملات URL
- ✅ إضافة دعم لمعاملات URL العادية
- ✅ إضافة دعم لمعاملات Hash Fragment
- ✅ تحسين رسائل الخطأ والتشخيص
- ✅ إضافة سجلات تفصيلية للتشخيص

### 2. تحسين إدارة الجلسة
- ✅ معالجة أفضل لـ tokens من البريد الإلكتروني
- ✅ تحسين التحقق من صحة الروابط
- ✅ إضافة رسائل خطأ أكثر وضوحاً

## 🧪 كيفية الاختبار

### الخطوة 1: اختبار إرسال البريد الإلكتروني
1. افتح التطبيق في المتصفح
2. انتقل إلى تبويب "حسابي"
3. اضغط على "تغيير كلمة المرور"
4. اضغط على "نسيت كلمة المرور"
5. أدخل بريد إلكتروني صحيح
6. اضغط "إرسال رابط إعادة التعيين"
7. تحقق من وصول البريد الإلكتروني

### الخطوة 2: اختبار الرابط
1. افتح البريد الإلكتروني
2. اضغط على رابط إعادة تعيين كلمة المرور
3. تحقق من أن الرابط يأخذك إلى صفحة إعادة تعيين كلمة المرور
4. تحقق من ظهور رسائل الخطأ أو النجاح

### الخطوة 3: استخدام صفحة الاختبار
1. افتح ملف `test-email-link.html` في المتصفح
2. انسخ رابط إعادة تعيين كلمة المرور من البريد الإلكتروني
3. الصق الرابط في المتصفح
4. تحقق من ظهور المعاملات في صفحة الاختبار

## 🔧 التشخيص

### فتح وحدة تحكم المتصفح (F12)
تحقق من السجلات التالية:

```javascript
// عند إرسال البريد الإلكتروني
console.log('Sending password reset email to:', email);
console.log('Redirect URL:', redirectUrl);

// عند فتح صفحة إعادة التعيين
console.log('URL Parameters:', { accessToken, refreshToken, type });
console.log('Hash Parameters:', { hashAccessToken, hashRefreshToken, hashType });
console.log('Setting session from email link tokens...');
console.log('Session set successfully:', userEmail);
```

### معاملات URL المتوقعة
```
/reset-password?access_token=xxx&refresh_token=yyy&type=recovery
```

### معاملات Hash المتوقعة
```
/reset-password#access_token=xxx&refresh_token=yyy&type=recovery
```

## 🚨 المشاكل المحتملة وحلولها

### المشكلة 1: الرابط يأخذ إلى الصفحة الرئيسية
**السبب:** إعدادات Supabase غير صحيحة
**الحل:** 
- تحقق من إعدادات `redirectTo` في Supabase
- تأكد من أن URL صحيح

### المشكلة 2: لا توجد معاملات في الرابط
**السبب:** Supabase لا يرسل المعاملات بشكل صحيح
**الحل:**
- تحقق من إعدادات Supabase Auth
- تأكد من أن `detectSessionInUrl: true`

### المشكلة 3: خطأ في إعداد الجلسة
**السبب:** tokens غير صالحة أو منتهية الصلاحية
**الحل:**
- طلب رابط جديد
- التحقق من صحة البريد الإلكتروني

## 📋 قائمة التحقق

- [ ] البريد الإلكتروني يصل بنجاح
- [ ] الرابط يحتوي على المعاملات المطلوبة
- [ ] صفحة إعادة تعيين كلمة المرور تفتح
- [ ] الجلسة تُنشأ بنجاح
- [ ] يمكن إدخال كلمة مرور جديدة
- [ ] كلمة المرور تُحدث بنجاح
- [ ] إعادة التوجيه إلى صفحة تسجيل الدخول

## 🔗 روابط مفيدة

### صفحة الاختبار
```
http://localhost:5174/test-email-link.html
```

### صفحة إعادة تعيين كلمة المرور
```
http://localhost:5174/reset-password
```

### رابط اختبار (مع معاملات وهمية)
```
http://localhost:5174/reset-password?access_token=test_token&refresh_token=test_refresh&type=recovery
```

## 📞 الدعم

إذا استمرت المشكلة:
1. تحقق من سجلات وحدة التحكم
2. تأكد من إعدادات Supabase
3. اختبر مع بريد إلكتروني مختلف
4. تحقق من إعدادات الشبكة والجدار الناري

## 🎯 النتيجة المتوقعة

بعد تطبيق التحسينات، يجب أن يعمل رابط إعادة تعيين كلمة المرور بشكل صحيح:
- ✅ الرابط يأخذ إلى صفحة إعادة تعيين كلمة المرور
- ✅ المعاملات تُقرأ بشكل صحيح
- ✅ الجلسة تُنشأ بنجاح
- ✅ يمكن للمستخدم إعادة تعيين كلمة المرور
- ✅ إعادة التوجيه إلى صفحة تسجيل الدخول
