========================================
إعداد نظام إشعارات التلغرام
========================================

📋 المتطلبات:
-------------
1. بوت تلغرام (احصل على Bot Token من @BotFather)
2. Supabase Project مع Edge Functions مفعلة

🚀 خطوات الإعداد:
-----------------

الخطوة 1: تطبيق Migrations
---------------------------
قم بتطبيق الـ migrations التالية بالترتيب:
1. supabase/migrations/20250105_create_telegram_config.sql
2. supabase/migrations/20250109_create_telegram_allowed_users.sql

الأوامر:
cd supabase
supabase db push


الخطوة 2: رفع Edge Functions
-----------------------------
قم برفع الـ edge functions:
1. telegram-webhook
2. telegram-bot-updates

الأوامر:
supabase functions deploy telegram-webhook
supabase functions deploy telegram-bot-updates


الخطوة 3: إضافة Bot Token
---------------------------
1. افتح لوحة التحكم في الموقع
2. اذهب إلى تاب "الـ Webhooks"
3. أضف Bot Token في إعدادات التلغرام
4. اختياري: أضف Admin Chat ID (لاستقبال الإشعارات كمشرف أيضاً)
5. فعّل "تفعيل التلغرام"
6. احفظ الإعدادات


الخطوة 4: إعداد Webhook
------------------------
قم بتشغيل سكربت الإعداد:

الأمر:
node setup-telegram-bot-webhook.js

سيقوم السكربت بـ:
- ربط البوت مع Edge Function
- التحقق من صحة الإعداد
- عرض رابط البوت


الخطوة 5: إضافة مستخدمين
--------------------------
1. افتح لوحة التحكم
2. اذهب إلى تاب "مستخدمي التلغرام"
3. اضغط على "إضافة مستخدم جديد"
4. أدخل:
   - الاسم الكامل
   - كود الدولة
   - رقم الهاتف (بدون أصفار في البداية)
   - (اختياري) اسم المستخدم في التلغرام
   - (اختياري) ملاحظات
5. احفظ


الخطوة 6: ربط المستخدمين
--------------------------
1. انسخ رابط البوت من صفحة "مستخدمي التلغرام"
2. أرسل الرابط للمستخدم
3. اطلب من المستخدم:
   - فتح الرابط
   - الضغط على "Start"
   - الضغط على زر "📱 إرسال رقم الهاتف"
   - إرسال رقم هاتفه
4. سيتم ربط الحساب تلقائياً
5. سيبدأ المستخدم باستقبال الإشعارات


⚠️ ملاحظات هامة:
-----------------
1. يجب أن يكون رقم الهاتف في قاعدة البيانات مطابقاً تماماً لرقم الهاتف في التلغرام
2. المستخدم يجب أن يكون لديه رقم هاتف مسجل في حسابه في التلغرام
3. إذا لم يظهر زر "إرسال رقم الهاتف"، اطلب من المستخدم تحديث تطبيق التلغرام


🔧 استكشاف الأخطاء:
--------------------

المشكلة: المستخدم لا يتلقى إشعارات
الحل:
1. تأكد من أن المستخدم نشط (is_active = true)
2. تأكد من أن المستخدم أرسل رقم هاتفه للبوت
3. تحقق من أن telegram_chat_id موجود في قاعدة البيانات
4. تأكد من تطابق رقم الهاتف


المشكلة: البوت لا يستجيب
الحل:
1. تحقق من صحة Bot Token
2. تأكد من رفع edge functions
3. تحقق من logs في Supabase Dashboard
4. أعد تشغيل setup-telegram-bot-webhook.js


المشكلة: خطأ عند إرسال رقم الهاتف
الحل:
1. تأكد من أن رقم الهاتف مضاف في قاعدة البيانات
2. تأكد من أن المستخدم نشط
3. تأكد من تطابق الأرقام (بدون أصفار أو فراغات إضافية)


📞 للمساعدة:
-------------
إذا واجهتك مشاكل، تحقق من:
1. Supabase Logs: Dashboard > Edge Functions > Logs
2. Telegram Bot Logs: https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo
3. Database: تحقق من جدول telegram_allowed_users


✅ تم الإعداد بنجاح!
--------------------
الآن يمكنك:
- إضافة مستخدمين بأرقام هواتفهم
- إرسال إشعارات تلقائية لجميع المستخدمين المصرح لهم
- إدارة المستخدمين (تفعيل/تعطيل/حذف)
- مراقبة حالة المستخدمين

