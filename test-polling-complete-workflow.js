import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function testPollingCompleteWorkflow() {
  console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø®Ø¯Ù…Ø© polling...');
  
  try {
    // 1. Ø¬Ù„Ø¨ Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    console.log('\n1ï¸âƒ£ Ø¬Ù„Ø¨ Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...');
    
    const { data: existingRequests, error: fetchError } = await supabase
      .from('health_insurance_requests')
      .select('*')
      .limit(1);

    if (fetchError || !existingRequests || existingRequests.length === 0) {
      console.error('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', fetchError);
      return;
    }

    const testRequest = existingRequests[0];
    console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø·Ù„Ø¨ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
    console.log('   â€¢ Request ID:', testRequest.id);
    console.log('   â€¢ Contact Name:', testRequest.contact_name);
    console.log('   â€¢ Current Status:', testRequest.status);

    // 2. Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ø¹ Ø£Ø²Ø±Ø§Ø±
    console.log('\n2ï¸âƒ£ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ø¹ Ø£Ø²Ø±Ø§Ø±...');
    
    const { data: config } = await supabase
      .from('telegram_config')
      .select('*')
      .eq('id', 1)
      .single();

    const notificationMessage = `ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø¯Ù…Ø© Polling - Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙƒØ§Ù…Ù„

ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:
â€¢ Ø§Ù„Ø§Ø³Ù…: ${testRequest.contact_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
â€¢ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${testRequest.contact_email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
â€¢ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${testRequest.contact_phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

ğŸ“ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:
${testRequest.additional_notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø© Ø¥Ø¶Ø§ÙÙŠØ©'}

ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:
â€¢ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: ØªØ£Ù…ÙŠÙ† ØµØ­ÙŠ Ù„Ù„Ø£Ø¬Ø§Ù†Ø¨
â€¢ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ğŸŸ¡ Ø¹Ø§Ø¯ÙŠØ©
â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${testRequest.status}

ğŸ¥ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„ØµØ­ÙŠ:
â€¢ Ø§Ù„Ø¹Ù…Ø±: ${testRequest.customer_age || 0} Ø³Ù†Ø©
â€¢ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ${testRequest.birth_date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
â€¢ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${testRequest.duration_months || 0} Ø´Ù‡Ø±
â€¢ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨: ${testRequest.calculated_price || 0} Ù„ÙŠØ±Ø© ØªØ±ÙƒÙŠØ©
â€¢ ØµÙˆØ±Ø© Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±: ${testRequest.passport_image_url ? 'Ù…Ø±ÙÙ‚Ø©' : 'ØºÙŠØ± Ù…Ø±ÙÙ‚Ø©'}

ğŸ†” Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨: ${testRequest.id}

âš ï¸ Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ø®Ø¯Ù…Ø© polling - Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡" Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«`;

    const sendResponse = await fetch(`https://api.telegram.org/bot${config.bot_token}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: config.admin_chat_id,
        text: notificationMessage,
        parse_mode: 'HTML',
        reply_markup: {
          inline_keyboard: [
            [
              { text: 'Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨', callback_data: `view_request:${testRequest.id}` },
              { text: 'Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„', callback_data: `contact_user:${testRequest.id}` }
            ],
            [
              { text: 'ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡', callback_data: `mark_resolved:${testRequest.id}` }
            ]
          ]
        }
      })
    });

    const sendResult = await sendResponse.json();

    if (!sendResult.ok) {
      console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', sendResult);
      return;
    }

    console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
    console.log('   â€¢ Message ID:', sendResult.result.message_id);
    console.log('   â€¢ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„');

    // 3. Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© updateRequestStatus
    console.log('\n3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© updateRequestStatus...');
    
    const originalStatus = testRequest.status;
    const testResult = await updateRequestStatus(testRequest.id, 'resolved');
    console.log('   â€¢ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«:', testResult ? 'âœ… Ù†Ø¬Ø­' : 'âŒ ÙØ´Ù„');

    // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
    console.log('\n4ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
    
    const { data: updatedRequest, error: fetchUpdatedError } = await supabase
      .from('health_insurance_requests')
      .select('*')
      .eq('id', testRequest.id)
      .single();

    if (fetchUpdatedError) {
      console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø«:', fetchUpdatedError);
    } else {
      console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­');
      console.log('   â€¢ Current Status:', updatedRequest.status);
      console.log('   â€¢ Updated At:', updatedRequest.updated_at);
    }

    // 5. Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù„Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
    console.log('\n5ï¸âƒ£ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù„Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…...');
    
    const confirmationMessage = `âœ… ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø¯Ù…Ø© Polling Ø¨Ù†Ø¬Ø§Ø­!

ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:
â€¢ Request ID: ${testRequest.id}
â€¢ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©: ${originalStatus}
â€¢ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ${updatedRequest.status}
â€¢ ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleString('ar-SA')}

ğŸ‰ Ø®Ø¯Ù…Ø© Polling ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!`;

    const confirmResponse = await fetch(`https://api.telegram.org/bot${config.bot_token}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: config.admin_chat_id,
        text: confirmationMessage,
        parse_mode: 'HTML'
      })
    });

    const confirmResult = await confirmResponse.json();

    if (!confirmResult.ok) {
      console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯:', confirmResult);
    } else {
      console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­');
      console.log('   â€¢ Confirmation Message ID:', confirmResult.result.message_id);
    }

    // 6. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    console.log('\n6ï¸âƒ£ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©...');
    
    const { error: restoreError } = await supabase
      .from('health_insurance_requests')
      .update({ status: originalStatus })
      .eq('id', testRequest.id);

    if (restoreError) {
      console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©:', restoreError);
    } else {
      console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
    }

    console.log('\nğŸ‰ ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø®Ø¯Ù…Ø© polling Ø¨Ù†Ø¬Ø§Ø­!');
    console.log('\nğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:');
    console.log('   âœ… ØªÙ… Ø¬Ù„Ø¨ Ø·Ù„Ø¨ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±');
    console.log('   âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ø¹ Ø£Ø²Ø±Ø§Ø±');
    console.log('   âœ… ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© updateRequestStatus');
    console.log('   âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«');
    console.log('   âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù„Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…');
    console.log('   âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©');
    
    console.log('\nğŸ” Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ:');
    console.log('   1. Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…');
    console.log('   2. Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡" ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø©');
    console.log('   3. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø®Ø¯Ù…Ø© polling Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨');
    console.log('   4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙƒØ§Ù…Ù„:', error);
  }
}

// Ø¯Ø§Ù„Ø© updateRequestStatus (Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ telegram-polling-service.js)
async function updateRequestStatus(sessionId, status) {
  try {
    console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ${sessionId} -> ${status}`);

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„ØµØ­ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© ID
    let { error: healthError } = await supabase
      .from('health_insurance_requests')
      .update({ status })
      .eq('id', sessionId);

    if (!healthError) {
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„ØµØ­ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© ID');
      return true;
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„ØµØ­ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© session_id (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯)
    let { error: sessionError } = await supabase
      .from('health_insurance_requests')
      .update({ status })
      .eq('session_id', sessionId);

    if (!sessionError) {
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„ØµØ­ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© session_id');
      return true;
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©
    let { error: serviceError } = await supabase
      .from('service_requests')
      .update({ status })
      .eq('id', sessionId);

    if (!serviceError) {
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©');
      return true;
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹ÙˆØ¯Ø© Ø§Ù„Ø·ÙˆØ¹ÙŠØ©
    let { error: voluntaryError } = await supabase
      .from('voluntary_return_forms')
      .update({ status })
      .eq('id', sessionId);

    if (!voluntaryError) {
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø§Ù„Ø·ÙˆØ¹ÙŠØ©');
      return true;
    }

    console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ù„ØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ Ø£ÙŠ Ø¬Ø¯ÙˆÙ„');
    console.log('   â€¢ ØªÙ… Ø§Ù„Ø¨Ø­Ø« ÙÙŠ: health_insurance_requests, service_requests, voluntary_return_forms');
    console.log('   â€¢ ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¨ÙˆØ§Ø³Ø·Ø©: id, session_id');
    return false;

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:', error);
    return false;
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
testPollingCompleteWorkflow();
