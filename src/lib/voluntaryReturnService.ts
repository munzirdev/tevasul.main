import { supabase } from './supabase';
import { VoluntaryReturnForm, CreateVoluntaryReturnFormData } from './types';

export const voluntaryReturnService = {
  // Create a new voluntary return form
  async createForm(formData: CreateVoluntaryReturnFormData): Promise<{ data: VoluntaryReturnForm | null; error: any }> {
    try {
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      
      if (authError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authError);
        return { data: null, error: { message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', details: authError } };
      }
      
      if (!user) {
        console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        return { data: null, error: { message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬' } };
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (!formData.full_name_tr || !formData.full_name_ar || !formData.kimlik_no || !formData.sinir_kapisi) {
        console.error('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
        return { data: null, error: { message: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ù…Ù„ÙˆØ¡Ø©' } };
      }

      const insertData = {
        user_id: user.id,
        full_name_tr: formData.full_name_tr,
        full_name_ar: formData.full_name_ar,
        kimlik_no: formData.kimlik_no,
        sinir_kapisi: formData.sinir_kapisi,
        gsm: formData.gsm || null,
        custom_date: formData.custom_date || null,
        refakat_entries: formData.refakat_entries || []
      };

      const { data, error } = await supabase
        .from('voluntary_return_forms')
        .insert(insertData)
        .select()
        .single();

      if (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
        
        // Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹
        let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬';
        
        if (error.code === 'PGRST205') {
          errorMessage = 'Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.';
        } else if (error.code === 'PGRST116') {
          errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
        } else if (error.message?.includes('not found')) {
          errorMessage = 'Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Supabase Dashboard.';
        } else if (error.message?.includes('permission')) {
          errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª RLS.';
        } else {
          errorMessage = error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬';
        }
        
        return { data: null, error: { message: errorMessage, details: error } };
      }

      return { data, error: null };
    } catch (error) {
      console.error('ğŸ’¥ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
      return { data: null, error: { message: 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬', details: error } };
    }
  },

  // Get all forms (admin only)
  async getAllForms(): Promise<{ data: VoluntaryReturnForm[] | null; error: any }> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      
      if (authError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authError);
        return { data: null, error: { message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', details: authError } };
      }
      
      if (!user) {
        console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        return { data: null, error: { message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' } };
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      
      const { data, error } = await supabase
        .from('voluntary_return_forms')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬:', error);
        return { data: null, error };
      }
      
      return { data, error: null };
    } catch (error) {
      console.error('ğŸ’¥ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬:', error);
      return { data: null, error: { message: 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬', details: error } };
    }
  },

  // Get forms for current user
  async getUserForms(): Promise<{ data: VoluntaryReturnForm[] | null; error: any }> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      
      if (authError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authError);
        return { data: null, error: { message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', details: authError } };
      }
      
      if (!user) {
        console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        return { data: null, error: { message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' } };
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      
      const { data, error } = await supabase
        .from('voluntary_return_forms')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        return { data: null, error };
      }
      
      return { data, error: null };
    } catch (error) {
      console.error('ğŸ’¥ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø¬Ù„Ø¨ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
      return { data: null, error: { message: 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø¬Ù„Ø¨ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', details: error } };
    }
  },

  // Get a single form by ID
  async getFormById(id: string): Promise<{ data: VoluntaryReturnForm | null; error: any }> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      
      if (authError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authError);
        return { data: null, error: { message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', details: authError } };
      }
      
      if (!user) {
        console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        return { data: null, error: { message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' } };
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();
      
      if (profileError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', profileError);
        return { data: null, error: { message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', details: profileError } };
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      const userRole = profile?.role || 'user';
      
      if (!userRole) {
        console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø¯ÙˆØ± Ù…Ø­Ø¯Ø¯');
        return { data: null, error: { message: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø¯ÙˆØ± Ù…Ø­Ø¯Ø¯' } };
      }
      
      const { data, error } = await supabase
        .from('voluntary_return_forms')
        .select('*')
        .eq('id', id)
        .single();

      if (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
        return { data: null, error };
      }
      
      return { data, error: null };
    } catch (error) {
      console.error('ğŸ’¥ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
      return { data: null, error: { message: 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬', details: error } };
    }
  },

  // Update a form
  async updateForm(id: string, formData: CreateVoluntaryReturnFormData): Promise<{ data: VoluntaryReturnForm | null; error: any }> {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      
      if (authError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authError);
        return { data: null, error: { message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', details: authError } };
      }
      
      if (!user) {
        console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        return { data: null, error: { message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' } };
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();
      
      if (profileError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', profileError);
        return { data: null, error: { message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', details: profileError } };
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      const userRole = profile?.role || 'user';
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ ØªØ­Ø¯ÙŠØ«Ù‡
      const { data: existingForm, error: fetchError } = await supabase
        .from('voluntary_return_forms')
        .select('user_id')
        .eq('id', id)
        .single();
      
      if (fetchError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', fetchError);
        return { data: null, error: fetchError };
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      if (userRole !== 'admin' && userRole !== 'moderator' && existingForm?.user_id !== user.id) {
        console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
        return { data: null, error: { message: 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬' } };
      }
      
      const { data, error } = await supabase
        .from('voluntary_return_forms')
        .update({
          full_name_tr: formData.full_name_tr,
          full_name_ar: formData.full_name_ar,
          kimlik_no: formData.kimlik_no,
          sinir_kapisi: formData.sinir_kapisi,
          gsm: formData.gsm || null,
          custom_date: formData.custom_date || null,
          refakat_entries: formData.refakat_entries
        })
        .eq('id', id)
        .select()
        .single();

      if (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
        return { data: null, error };
      }
      
      return { data, error: null };
    } catch (error) {
      console.error('ğŸ’¥ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
      return { data: null, error: { message: 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬', details: error } };
    }
  },

  // Delete a form
  async deleteForm(id: string): Promise<{ error: any }> {
    try {
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      
      if (authError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authError);
        return { error: { message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', details: authError } };
      }
      
      if (!user) {
        console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        return { error: { message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' } };
      }
      
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();
      
      if (profileError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', profileError);
        return { error: { message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', details: profileError } };
      }
      
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¯ÙˆØ± Ù…Ø­Ø¯Ø¯ØŒ Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ
      const userRole = profile?.role || 'user';
      
      // Admin Ø£Ùˆ Moderator ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ø£ÙŠ Ù†Ù…ÙˆØ°Ø¬
      if (userRole === 'admin' || userRole === 'moderator') {
        const { error: deleteError } = await supabase
          .from('voluntary_return_forms')
          .delete()
          .eq('id', id);

        if (deleteError) {
          console.error('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', deleteError);
          return { error: { message: 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬', details: deleteError } };
        }
        
        return { error: null };
      }
      
      // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ù†Ù…Ø§Ø°Ø¬Ù‡ ÙÙ‚Ø·
      const { data: formData, error: fetchError } = await supabase
        .from('voluntary_return_forms')
        .select('user_id')
        .eq('id', id)
        .single();
      
      if (fetchError) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', fetchError);
        return { error: { message: 'Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', details: fetchError } };
      }
      
      if (!formData?.user_id || formData?.user_id !== user.id) {
        console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
        return { error: { message: 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬' } };
      }
      
      const { error: deleteError } = await supabase
        .from('voluntary_return_forms')
        .delete()
        .eq('id', id);

      if (deleteError) {
        console.error('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', deleteError);
        return { error: { message: 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬', details: deleteError } };
      }
      
      return { error: null };
    } catch (error) {
      return { error: { message: 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬', details: error } };
    }
  }
};
